$(document).ready((function(){let e,t=document.getElementById("ds_panel_header"),a=document.getElementById("search_names"),o=document.getElementById("close_search");function n(){document.querySelectorAll(".col").forEach((e=>{e.style.display="block"}))}a.addEventListener("focusin",(function(){t.classList.add("search_active")})),a.addEventListener("focusout",(function(){t.classList.remove("search_active"),a.value="",n()})),o.addEventListener("click",(function(){t.classList.remove("search_active"),a.value="",n()})),$.ajax({url:"admin_llaves",type:"POST",data:{action_type:"search_profesores"},dataType:"json",success:function(t){e=t},error:function(e){alert("No hay usuarios, redirigiendo a modulo de perfiles para crear al menos un profesor"),window.location.href="admin_perfiles"}});const s=document.querySelectorAll(".col"),l=document.getElementById("search_names"),i=document.querySelectorAll('input[name="filters_actividad"]');function r(){const e=l.value.toLowerCase();let t=!1,a=!1;i.forEach((e=>{e.checked&&("see_key_retiros"===e.id?t=!0:"see_key_devoluciones"===e.id&&(a=!0))})),s.forEach((o=>{const n=o.dataset.kn.toLowerCase(),s=o.dataset.kan.toLowerCase(),l=o.dataset.kst,i=n.includes(e)||s.includes(e);let r=!1;t&&"0"===l&&i||a&&"1"===l&&i?r=!0:t||a||!i||(r=!0),o.style.display=r?"block":"none"}))}l.addEventListener("input",r),i.forEach((e=>{e.addEventListener("change",r)}));const c=new Audio("./public/assets/audio/success.mp3"),d=document.getElementById("navigation_mobile");let u=0;window.addEventListener("scroll",(function(){let e=window.pageYOffset||document.documentElement.scrollTop;d.style.bottom=e>u?"-72px":"0",u=e<=0?0:e;const t=document.getElementById("ds_panel_header"),a=document.getElementById("ds_panel_body");window.scrollY>=95?(t.style.position="fixed",t.style.top="0",a.style.marginTop="80px"):(t.style.position="static",t.style.top="unset",a.style.marginTop="0px")})),$(".btn_change_key_state").each((function(){const e=this.closest(".col"),t=this.getAttribute("data-free-key"),a=(e.getAttribute("data-knp"),e.getAttribute("data-kst")),o=e.getAttribute("data-kru"),n=e.querySelector(".key_use_reason"),s=e.querySelector(".act_key_info"),l=e.querySelector(".key_portador");this.addEventListener("change",(function(){t!=a&&(s.disabled=!1),"1"==t?(l.removeAttribute("readonly"),n.removeAttribute("readonly"),n.value=""!=o&&"Sin razón"!=n.value?o:"",l.value=""):"0"==t&&(l.setAttribute("readonly",!0),n.setAttribute("readonly",!0),n.value="Sin razón",l.value="Sin portador/a"),"0"==t&&a==t&&(s.disabled=!0)}))})),$(".key_use_reason").each((function(){const e=this.closest(".col"),t=$(e).find(".act_key_info");this.addEventListener("input",(()=>{t.attr("disabled",!1)}))})),$(".key_portador").each((function(){const e=this.closest(".col"),t=$(e).find(".act_key_info");this.addEventListener("input",(()=>{t.attr("disabled",!1)}))})),$(".act_key_info").each((function(){const t=this.closest(".col"),a=t.getAttribute("data-kn"),o=t.querySelector(".key_portador"),n=t.querySelector(".key_use_reason");let s=!1;this.addEventListener("click",(async function(){this.disabled=!0,this.innerHTML="Procesando...";const l=t.querySelector('input[name="btn_state_group_'+a+'"]:checked').getAttribute("data-free-key");let i=!1,r="";if(e.forEach((e=>{e[1]==o.value&&(i=!0,r=e[0])})),""!=n.value&&""!=o.value&&(i||"Sin portador/a"==o.value&&0==l)){i||"Sin portador/a"!=o.value||(r=null);try{let e=await $.ajax({url:"admin_llaves",type:"POST",data:{action_type:"consult_update_pos",key_to_update:a}});if(s="GO"==e,s)try{"SUCCESS"==await $.ajax({url:"admin_llaves",type:"POST",data:{action_type:"update_key",key_to_update:a,act_portador:r,act_reason:n.value,act_key_state:l}})?(c.play(),$("#info_process_text").html("La actualización ha sido exitosa"),$("#modal_info_proceso").modal("show")):(console.log("No pudimos procesar la actualización, inténtelo más tarde."),window.location.href="admin_llaves")}catch(e){alert("No pudimos procesar la actualización, inténtelo más tarde."),window.location.href="admin_llaves"}else alert("La llave no puede ser actualizada.\n\nMotivo: La llave esta siendo utilizada según establecido horario del profesor"),window.location.href="admin_llaves"}catch(e){alert("No pudimos procesar la consulta, inténtelo más tarde."),window.location.href="admin_llaves"}}else i?alert("Ingrese la información necesaria para la actualización de la llave, ya sea el nombre del portador o la razón de uso."):alert("Ingrese un nombre de portador válido"),this.innerHTML="Actualizar llave",this.disabled=!1}))}))}));