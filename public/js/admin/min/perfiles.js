$(document).ready((function(){[...document.querySelectorAll('[data-bs-toggle="tooltip"]')].map((e=>new bootstrap.Tooltip(e)));$("#reload_page_profiles").on("click",(function(){location.reload(!0)}));document.querySelectorAll(".filter_users_kind").forEach((e=>{e.addEventListener("input",(function(){let a=document.querySelectorAll(".profile_row"),s=document.querySelectorAll(".profile_row .rol .info_data");switch(e.id){case"see_all_users":a.forEach((e=>{e.style.display=""}));break;case"see_profesores":a.forEach(((e,a)=>{"Profesor"==s[a].innerHTML.trim()?e.style.display="":e.style.display="none"}));break;case"see_admins":a.forEach(((e,a)=>{"Administrador"==s[a].innerHTML.trim()?e.style.display="":e.style.display="none"}))}}))})),document.getElementById("search_names").addEventListener("input",(function(){$("#see_all_users").attr("checked",!0);let e=this.value.toLowerCase().trim(),a=document.querySelectorAll(".profile_row"),s=document.querySelectorAll(".profile_row .prof_search_by_name .info_data");a.forEach(((a,t)=>{s[t].innerText.toLowerCase().trim().includes(e)?a.style.display="":a.style.display="none"}))}));let e=new FormData;new FormData;const a=new Audio("./public/assets/audio/success.mp3"),s=new Audio("./public/assets/audio/fail.mp3"),t=document.getElementById("navigation_mobile");let o=0;window.addEventListener("scroll",(function(){let e=window.pageYOffset||document.documentElement.scrollTop;e>o?($("#create_user").css("bottom","40px"),t.style.bottom="-72px"):($("#create_user").css("bottom","80px"),t.style.bottom="0"),o=e<=0?0:e;const a=document.getElementById("ds_panel_header"),s=document.getElementById("ds_panel_body");window.scrollY>=95?(a.style.position="fixed",a.style.top="0",s.style.marginTop="80px"):(a.style.position="static",a.style.top="unset",s.style.marginTop="0px")}));let r=document.getElementById("ds_panel_header"),l=document.getElementById("search_names"),c=document.getElementById("close_search");l.addEventListener("focusin",(function(){r.classList.add("search_active")})),l.addEventListener("focusout",(function(){r.classList.remove("search_active"),l.value=""})),c.addEventListener("click",(function(){r.classList.remove("search_active"),l.value=""}));let i=[],n=[],d=[],_=[];$.ajax({url:"admin_perfiles",type:"POST",data:{action_type:"get_esps_&_users_&_aulas"},success:function(e){i=e.especialidades,n=e.users,d=e.subareas,_=e.aulas},error:function(e){console.log(e.responseText)}});const p=document.querySelectorAll(".call_user");let u="",h="",m="",v="",f="",y="",b="",g="",C=[!1,!1,!1,!1];function E(e,a){e?(C[a]=!0,console.log(C)):e||(C[a]=!1,console.log(C)),$("#updateProfile").attr("disabled",!1)}let w=!1;function k(){$("#search_photo_perfil_img").attr("src","./public/assets/images/fotos_perfil/default.webp"),$("#search_ced").html(""),$("#search_rol").html(""),$("#search_photo_perfil").val(null),$("#search_nombrecom").val(null).removeClass("is-invalid").removeClass("is-valid"),$("#search_correoinst").val(null).removeClass("is-invalid").removeClass("is-valid"),$("#search_phonect").val(null).removeClass("is-invalid").removeClass("is-valid"),$("#search_correoct").val(null).removeClass("is-invalid").removeClass("is-valid"),$("#search_contrainst").val(null).removeClass("is-invalid").removeClass("is-valid"),g="",v="",u="",h="",m="",y="",b="",w=!1}k(),$(".close_profile").on("click",k),p.forEach((e=>{e.addEventListener("click",(function(a){a.preventDefault(),k(),$("#modal_body_perfil").hide(),$("#loader_update_prof").hide();let t=e.attributes.id.value;const o=document.getElementById("loader_perfil");o.style.display="flex",$.ajax({url:"admin_perfiles",type:"POST",data:{action_type:"search_unique_user",profile_ced:t},dataType:"json",success:function(e){$("#modal_body_perfil").show(),o.style.display="none",$("#search_photo_perfil_img").attr("src",e.link_photo),$("#search_ced").html(e.cedula),"Administrador"==e.rol?$("#search_rol").html(`${e.rol}`):$("#search_rol").html(`${e.rol} - ${e.especialidad}`),"Administrador"==e.rol?$("#search_schedule").css("display","none"):$("#search_schedule").css("display","flex"),v=e.rol,f=e.idEspecialidad,$("#search_nombrecom").val(e.nombre),$("#search_correoinst").val(e.correoins),$("#search_phonect").val(e.phonect),$("#search_correoct").val(e.correoct),g=e.cedula,u=e.link_photo,h=e.nombre,m=e.correoins,y=e.phonect,b=e.correoct},error:function(e,a,t){s.play(),o.style.display="none",alert(t),location.reload(!0)}})}))})),$("#search_schedule").on("click",(function(e){$("#profile_modal").modal("hide"),$("#update_schedule_modal").modal("show")}));let x=document.getElementById("search_photo_perfil_img");$("#delete_photo_profile_act").on("click",(function(){x.src="./public/assets/images/fotos_perfil/default.webp",$("#search_photo_perfil").val(null),w=!0,$("#updateProfile").attr("disabled",!1)})),$(".search_user_input").on("input",(function(){switch($(this).attr("id")){case"search_nombrecom":""==$(this).val()?($("#search_nombrecom").addClass("is-invalid").removeClass("is-valid"),E(!0,0)):($("#search_nombrecom").removeClass("is-invalid").addClass("is-valid"),E(!1,0));break;case"search_correoinst":let e=!1;this.value=this.value.toLowerCase(),n.forEach((a=>{$("#search_correoinst").val()===a[2]&&(e=!0)})),e&&$(this).val()!=m||""==$(this).val()||!$(this).val().endsWith("@covao.ed.cr")||"@covao.ed.cr"==$(this).val()?($("#search_correoinst").addClass("is-invalid").removeClass("is-valid"),E(!0,1)):($("#search_correoinst").removeClass("is-invalid").addClass("is-valid"),E(!1,1));break;case"search_contrainst":""!=$(this).val()&&$(this).val().length<=7?($("#search_contrainst").addClass("is-invalid").removeClass("is-valid"),E(!0,2)):($("#search_contrainst").removeClass("is-invalid").addClass("is-valid"),E(!1,2)),""===$(this).val()&&($("#search_contrainst").removeClass("is-invalid").removeClass("is-valid"),E(!1,2));break;case"search_phonect":$(this).val($(this).val().replace(/[^0-9]/g,"")),$(this).val().length>8&&$(this).val($(this).val().slice(0,8)),$(this).val().length<8?($("#search_phonect").addClass("is-invalid").removeClass("is-valid"),E(!0,3)):($("#search_phonect").removeClass("is-invalid").addClass("is-valid"),E(!1,3));break;case"search_correoct":this.value=this.value.toLowerCase(),""!=$(this).val()&&!$(this).val().includes("@")||$(this).val().endsWith("@")?$("#search_correoct").addClass("is-invalid").removeClass("is-valid"):($("#search_correoct").removeClass("is-invalid"),$("#updateProfile").attr("disabled",!0));break;case"search_photo_perfil":let a=this.files[0];if(a){if(!["image/jpeg","image/png","image/webp"].includes(a.type))return alert("Por favor, selecciona una imagen válida (JPEG, PNG, o WEBP)."),void(this.value="");w=!1;const e=new FileReader;e.onload=function(e){const a=new Image;a.onload=function(){x.src=e.target.result,w=!1},a.onerror=function(){this.value=""},a.src=e.target.result},e.onerror=function(){alert("Hubo un error al leer el archivo. Por favor, intenta con otra imagen."),this.value="",x.src="./public/assets/images/fotos_perfil/default.webp"},e.readAsDataURL(a)}else x.src="./public/assets/images/fotos_perfil/default.webp"}C.length>0&&C.every((e=>!1===e))?$("#updateProfile").attr("disabled",!1):$("#updateProfile").attr("disabled",!0)})),$("#updateProfile").on("click",(function(){const s=document.getElementById("search_photo_perfil").files[0];e.append("action_type","update_single_user"),e.append("photo_profile",s),w?e.append("default_profile_true",!0):e.append("default_profile_true",!1),e.append("ced",g),e.append("nombre",$("#search_nombrecom").val()),e.append("mail_inst",$("#search_correoinst").val()),""==$("#search_contrainst").val()||$("#search_contrainst").val().length<8?e.append("pass_inst",!1):e.append("pass_inst",$("#search_contrainst").val()),e.append("numct",$("#search_phonect").val()),""==$("#search_correoct").val()||"n/a"==$("#search_correoct").val()?e.append("mailct",""):e.append("mailct",$("#search_correoct").val()),$("#updateProfile").attr("disabled",!0),$("#loader_update_span").hide(),$("#loader_update_prof").show(),$.ajax({url:"admin_perfiles",type:"POST",data:e,contentType:!1,processData:!1,success:function(e){console.log(e),a.play(),$("#profile_modal").modal("hide"),$("#info_process_profile_modal").modal("show"),$("#info_process_text").html(e.updateResponse)},error:function(e){console.log(e)}})})),$("#deleteProfile").on("click",(function(){$("#confirm_delete_user").html(`¿Está usted de acuerdo en eliminar al usuario ${h}? <br> <b>Recuerde que esta acción es irreversible.<b/>`)})),$("#confirm_delete_user_btn").on("click",(function(){$("#confirm_delete_user_btn").attr("disabled",!0),$.ajax({url:"admin_perfiles",type:"POST",data:{action_type:"delete_single_user",delete_ced:g,delete_user_rol:v},success:function(e){a.play(),$("#delete_profile_modal").modal("hide"),$("#info_process_profile_modal").modal("show"),console.log(e),"OK"==e&&$("#info_process_text").html("El usuario se ha eliminado con éxito.")},error:function(e){alert("Error al eliminar al usuario"),location.reload()}})}));const L=document.getElementById("form_body_schedule_update");let S=L.querySelectorAll(".subarea"),T=L.querySelectorAll(".llave"),A=!1;$("#search_schedule").on("click",(function(){B(1),T.forEach((function(e){e.value="",e.innerHTML=""})),S.forEach((function(e){e.value="",e.innerHTML=""})),$.ajax({url:"admin_perfiles",type:"POST",data:{action_type:"search_schedule_professor",professor_ced:g},dataType:"json",success:function(e){A=""==e,""!=e&&e[0]&&e[0][2]?$("#seccion_profesor_upt").val(e[0][2]):$("#seccion_profesor_upt").val("");let a=(new Date).getFullYear();if(""!=e&&e[0]&&e[0][6]){$("#sch_year").html(e[0][6]);let s=parseInt(e[0][6]);s<a?$("#sch_year").addClass("text-danger").removeClass("text-success"):s==a&&$("#sch_year").removeClass("text-danger").addClass("text-success")}else $("#sch_year").removeClass("text-danger").addClass("text-success"),$("#sch_year").html(a);S.forEach(((a,s)=>{let t=document.createElement("option");t.value=1,t.innerHTML="Lección vacía",a.appendChild(t),d.forEach((o=>{if(f==o.idEspecialidad){let r=document.createElement("option");r.value=o.idSubarea,r.innerHTML=o.nombreSubarea,e[s]&&e[s][3]==o.idSubarea?r.selected=!0:e[s]&&1==e[s][3]&&(t.selected=!0),a.appendChild(r)}}))})),T.forEach(((a,s)=>{_.forEach((t=>{let o=document.createElement("option");o.value=t.numeroLlave,o.innerHTML=t.nombreAula,e[s]&&e[s][5]==t.numeroLlave&&(o.selected=!0),a.appendChild(o),1==A&&(a.value=999)}))}))},error:function(e){console.log(e)}})})),$("#seccion_profesor_upt").on("input",(function(){$("#update_schedule_professor").attr("disabled",!1)})),S.forEach((e=>{e.addEventListener("change",(function(){$("#update_schedule_professor").attr("disabled",!1)}))})),T.forEach((e=>{e.addEventListener("change",(function(){$("#update_schedule_professor").attr("disabled",!1)}))})),$("#spinner_upt_sch").hide(),$("#update_schedule_professor").on("click",(function(){$(this).attr("disabled",!0),$("#text_upt_sch").hide(),$("#spinner_upt_sch").show();let e=new FormData,s=Array.from(L.querySelectorAll(".subarea")).map((e=>e.value)),t=Array.from(L.querySelectorAll(".llave")).map((e=>e.value));e.append("subareas",JSON.stringify(s)),e.append("keys",JSON.stringify(t)),e.append("cedula_profesor",g),e.append("seccion_profesor",$("#seccion_profesor_upt").val()),e.append("action_type","update_schedule_professor"),e.append("new_user_sch",A),$.ajax({url:"admin_perfiles",type:"POST",data:e,processData:!1,contentType:!1,success:function(e){"SUCCESS"==e&&(a.play(),$("#update_schedule_modal").modal("hide"),$("#info_process_profile_modal").modal("show"),$("#info_process_text").html(`El horario del profesor ${h} se ha actualizado con éxito.`))},error:function(e,a,s,t){console.error("Error:",e)}})})),$("#create_esp_cont").hide(),$("#create_esp").val("Administrador"),$("value_esp_admin").hide(),$("#create_rol").on("change",(function(){"Administrador"==$("#create_rol").val()?($("#create_esp_cont").hide(),$("#create_esp").val(1),$("#create_profile_text").html("Crear perfil")):($("#create_esp_cont").show(),$("#create_esp").val(2))}));const P=document.querySelectorAll(".create_user_input");let j=[!1,!1,!1,!1,!1];function I(e){let a=0;for(let s=0;s<e.length;s++){e[s]&&a++}a<5?$("#create_profile_btn").attr("disabled",!0):$("#create_profile_btn").attr("disabled",!1)}let O=!1;P.forEach((e=>{e.addEventListener("input",(function(){const a=e.id,s=$("#"+a).val(),t=(e,a)=>{e?$(a).addClass("is-valid").removeClass("is-invalid"):$(a).addClass("is-invalid").removeClass("is-valid")},o=(e,a)=>!n.some((s=>s[a]===e));switch(a){case"create_ced":const e=""!==s&&s>1e7;j[0]=e,t(e&&o(s,0),"#create_ced");break;case"create_nombrecom":const r=""!==s&&/^[a-zA-Z0-9\s]+$/.test(s);j[1]=r,t(r,"#create_nombrecom");break;case"create_correoinst":this.value=this.value.toLowerCase();let l=s;const c="covao.ed.cr",i=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;l.includes("@")&&!O&&(l.endsWith(c)||($("#"+a).val(l+c),O=!0)),l.includes("@")||(O=!1);const n=""!==l&&i.test(l)&&l.endsWith(c)&&l!==`@${c}`;j[2]=n,t(n&&o(l,2),"#create_correoinst");break;case"create_contrainst":const d=""!==s&&s.length>7&&"12345678"!==s;j[3]=d,t(d,"#create_contrainst");break;case"create_phonect":const _=/^[2867]/,p=""!==s&&s.length>7&&_.test(s);j[4]=p,t(p,"#create_phonect")}I(j)}))}));let q=1;function B(e){switch($(".cl_containers").css({transition:"0.4s all ease",opacity:"0.05"}),setTimeout((()=>{$(".cl_containers").css("opacity","1")}),100),e){case 1:$(".schedule_day").html("Lunes"),$(".cl_lunes").show(),$(".cl_martes").hide(),$(".cl_miercoles").hide(),$(".cl_jueves").hide(),$(".cl_viernes").hide();break;case 2:$(".schedule_day").html("Martes"),$(".cl_lunes").hide(),$(".cl_martes").show(),$(".cl_miercoles").hide(),$(".cl_jueves").hide(),$(".cl_viernes").hide();break;case 3:$(".schedule_day").html("Miércoles"),$(".cl_lunes").hide(),$(".cl_martes").hide(),$(".cl_miercoles").show(),$(".cl_jueves").hide(),$(".cl_viernes").hide();break;case 4:$(".schedule_day").html("Jueves"),$(".cl_lunes").hide(),$(".cl_martes").hide(),$(".cl_miercoles").hide(),$(".cl_jueves").show(),$(".cl_viernes").hide();break;case 5:$(".schedule_day").html("Viernes"),$(".cl_lunes").hide(),$(".cl_martes").hide(),$(".cl_miercoles").hide(),$(".cl_jueves").hide(),$(".cl_viernes").show()}!function(){const e=$(".schedule_day").html().trim().toLowerCase();"lunes"===e?$(".back_day").addClass("cant_move"):"viernes"===e?$(".next_day").addClass("cant_move"):($(".back_day").removeClass("cant_move"),$(".next_day").removeClass("cant_move"))}()}$(".cl_lunes").show(),$(".cl_martes").hide(),$(".cl_miercoles").hide(),$(".cl_jueves").hide(),$(".cl_viernes").hide(),$(".back_day").on("click",(function(){q>1&&(q--,B(q)),$("#schedule_templ").animate({scrollTop:0},"smooth")})),$(".next_day").on("click",(function(){q<5&&(q++,B(q)),$("#schedule_templ").animate({scrollTop:0},"smooth")}));const D=document.getElementById("create_photo_perfil");P.forEach((e=>{e.addEventListener("input",(function(){const a=e.id,s=$("#"+a).val(),t=(e,a)=>{e?$(a).addClass("is-valid").removeClass("is-invalid"):$(a).addClass("is-invalid").removeClass("is-valid")},o=(e,a)=>!n.some((s=>s[a]===e));switch(a){case"create_ced":const e=""!==s&&s>1e8;j[0]=e,t(e&&o(s,0),"#create_ced");break;case"create_nombrecom":const r=""!==s&&/^[a-zA-Z0-9\s]+$/.test(s);j[1]=r,t(r,"#create_nombrecom");break;case"create_correoinst":let l=s;const c="covao.ed.cr",i=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;$("#create_correoinst").val($("#create_correoinst").val().toLowerCase()),l.includes("@")&&!O&&(l.endsWith(c)||($("#"+a).val(l+c),O=!0)),l.includes("@")||(O=!1);const n=""!==l&&i.test(l)&&l.endsWith(c)&&l!==`@${c}`;j[2]=n,t(n&&o(l,2),"#create_correoinst");break;case"create_contrainst":const d=""!==s&&s.length>7&&"12345678"!==s;j[3]=d,t(d,"#create_contrainst");break;case"create_phonect":const _=/^[2867]/,p=""!==s&&s.length>7&&_.test(s);j[4]=p,t(p,"#create_phonect");break;case"create_correoct":this.value=this.value.toLowerCase();""==this.value||this.value.includes("@")?$("#create_correoct").removeClass("is-invalid").addClass("is-valid"):$("#create_correoct").addClass("is-invalid").removeClass("is-valid")}I(j)}))})),$("#create_photo_perfil").on("input",(function(){const e=$("#create_photo_perfil")[0].files[0];if(e){const a=e.type;if(a.startsWith("image/jpeg")||a.startsWith("image/jpg")||a.startsWith("image/png")||a.startsWith("image/webp")){const a=URL.createObjectURL(e);$("#create_photo_perfil_img").attr("src",a)}else $("#create_photo_perfil").val(""),alert("⚠️ Error: El archivo adjunto NO es una imagen ⚠️")}else $("#create_photo_perfil").val("")})),$("#delete_photo_profile_create").on("click",(function(){$("#create_photo_perfil_img").attr("src","./public/assets/images/fotos_perfil/default.webp"),D.value=""})),$("#create_profile_btn").on("click",(function(e){if(e.preventDefault(),j.every((e=>!0===e))){$("#create_profile_btn").attr("disabled",!0);const e=new FormData,s=document.getElementById("create_photo_perfil").files[0];e.append("cr_photo_profile",s),e.append("cr_cedula",$("#create_ced").val()),e.append("cr_nombreCompleto",$("#create_nombrecom").val()),e.append("cr_rol",$("#create_rol").val()),console.log($("#create_rol").val()),"Administrador"==$("#create_rol").val()?e.append("cr_especialidad",1):e.append("cr_especialidad",$("#create_esp").val()),e.append("cr_correoInst",$("#create_correoinst").val()),e.append("cr_passInst",$("#create_contrainst").val()),e.append("cr_telefonoContacto",$("#create_phonect").val()),e.append("cr_correoContacto",$("#create_correoct").val()),e.append("action_type","create_single_user"),$.ajax({url:"admin_perfiles",type:"POST",data:e,contentType:!1,processData:!1,success:function(e){a.play(),console.log(e),$("#create_user_modal").modal("hide"),$("#info_process_profile_modal").modal("show"),"OK"==e.createUSR&&"Administrador"==$("#create_rol").val()?$("#info_process_text").html("El usuario se ha creado con éxito."):"OK"==e.createUSR&&"Profesor"==$("#create_rol").val()&&$("#info_process_text").html("El usuario se ha creado con éxito, para asignar el respectivo horario, debe ingreser al perfil del profesor/a y seleccionar la opción de Horario.")},error:function(e){console.log(e)}})}else alert("Por favor, corrija los errores antes de crear el usuario.")}))}));